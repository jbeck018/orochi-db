# Orochi DB - PostgreSQL Extension CI/CD Pipeline
# Comprehensive CI workflow for building, testing, and validating the extension

name: Extension CI

on:
  push:
    branches:
      - main
      - master
      - develop
      - 'release/**'
      - 'feature/**'
  pull_request:
    branches:
      - main
      - master
      - develop

# Cancel in-progress runs when a new run is triggered on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # PostgreSQL version for extension build validation
  PG_VERSION: '16'

jobs:
  # Static analysis and code formatting checks (fast feedback)
  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install static analysis tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            cppcheck \
            clang-format

      - name: Run cppcheck static analysis
        run: make lint

      - name: Check code formatting
        run: make check-format

  # Build the extension and run unit tests
  build-and-test:
    name: Build and Test (PostgreSQL ${{ matrix.pg_version }})
    runs-on: ubuntu-latest
    needs: lint-and-format
    strategy:
      fail-fast: false
      matrix:
        pg_version: ['16', '17']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/apt/archives
          key: apt-${{ runner.os }}-${{ matrix.pg_version }}-${{ hashFiles('.github/workflows/extension-ci.yml') }}
          restore-keys: |
            apt-${{ runner.os }}-${{ matrix.pg_version }}-

      - name: Install PostgreSQL ${{ matrix.pg_version }} development headers
        run: |
          sudo apt-get update

          # Install PostgreSQL repository for specific versions
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update

          # Install PostgreSQL server dev headers for the specific version
          sudo apt-get install -y --no-install-recommends \
            postgresql-${{ matrix.pg_version }} \
            postgresql-server-dev-${{ matrix.pg_version }}

      - name: Install build dependencies
        run: |
          sudo apt-get install -y --no-install-recommends \
            liblz4-dev \
            libzstd-dev \
            libcurl4-openssl-dev \
            libssl-dev \
            librdkafka-dev \
            build-essential

      - name: Cache extension build artifacts
        uses: actions/cache@v4
        with:
          path: |
            src/**/*.o
            *.so
          key: build-${{ runner.os }}-pg${{ matrix.pg_version }}-${{ hashFiles('src/**/*.c', 'src/**/*.h', 'Makefile') }}
          restore-keys: |
            build-${{ runner.os }}-pg${{ matrix.pg_version }}-

      - name: Set PostgreSQL path
        run: |
          echo "PATH=/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH" >> $GITHUB_ENV

      - name: Verify PostgreSQL version
        run: |
          pg_config --version
          make check-version || echo "Version check completed"

      - name: Build extension
        run: |
          make clean
          make PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config

      - name: Verify build artifacts
        run: |
          ls -la *.so 2>/dev/null || echo "No shared library built (check build output)"
          ls -la src/**/*.o 2>/dev/null | head -20 || echo "No object files found"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: orochi-pg${{ matrix.pg_version }}-${{ github.sha }}
          path: |
            *.so
            sql/*.sql
          retention-days: 7
          if-no-files-found: warn

  # Run standalone unit tests (no PostgreSQL required)
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            gcc

      - name: Cache unit test build
        uses: actions/cache@v4
        with:
          path: |
            test/unit/*.o
            test/unit/run_tests
          key: unit-tests-${{ runner.os }}-${{ hashFiles('test/unit/**/*.c', 'test/unit/**/*.h', 'test/unit/Makefile') }}
          restore-keys: |
            unit-tests-${{ runner.os }}-

      - name: Build unit tests
        working-directory: test/unit
        run: |
          make clean
          make

      - name: Run unit tests
        working-directory: test/unit
        run: ./run_tests

      - name: Run unit tests (verbose)
        working-directory: test/unit
        run: ./run_tests --verbose
        if: failure()

  # Debug build to catch additional issues
  debug-build:
    name: Debug Build
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PostgreSQL 16 development headers
        run: |
          sudo apt-get update
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            postgresql-16 \
            postgresql-server-dev-16

      - name: Install build dependencies
        run: |
          sudo apt-get install -y --no-install-recommends \
            liblz4-dev \
            libzstd-dev \
            libcurl4-openssl-dev \
            libssl-dev \
            librdkafka-dev \
            build-essential

      - name: Build with debug flags
        run: |
          make clean
          make DEBUG=1 PG_CONFIG=/usr/lib/postgresql/16/bin/pg_config

      - name: Verify debug build
        run: |
          # Check that debug symbols are present
          file *.so 2>/dev/null | grep -i "not stripped" || echo "Build completed"

  # Summary job that depends on all others
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      - lint-and-format
      - build-and-test
      - unit-tests
      - debug-build
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [ "${{ needs.lint-and-format.result }}" != "success" ]; then
            echo "Lint and format check failed"
            exit 1
          fi
          if [ "${{ needs.build-and-test.result }}" != "success" ]; then
            echo "Build and test failed"
            exit 1
          fi
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "Unit tests failed"
            exit 1
          fi
          if [ "${{ needs.debug-build.result }}" != "success" ]; then
            echo "Debug build failed"
            exit 1
          fi
          echo "All CI checks passed successfully!"
