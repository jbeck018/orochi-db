# Orochi DB - PostgreSQL Extension CI Pipeline
# Builds, tests, and validates the C extension across PostgreSQL versions

name: Extension CI

on:
  workflow_call:
  push:
    branches:
      - main
      - develop
    paths:
      - 'extensions/postgres/**'
      - 'src/**'
      - 'test/**'
      - 'sql/**'
      - 'Makefile'
      - '.github/workflows/extension-ci.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'extensions/postgres/**'
      - 'src/**'
      - 'test/**'
      - 'sql/**'
      - 'Makefile'
      - '.github/workflows/extension-ci.yml'

concurrency:
  group: extension-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Static analysis and code formatting checks (fast feedback)
  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install static analysis tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            cppcheck \
            clang-format

      - name: Run cppcheck static analysis
        run: make lint
        working-directory: ${{ github.workspace }}

      - name: Check code formatting
        run: make check-format
        working-directory: ${{ github.workspace }}

  # Build and test with multiple PostgreSQL versions
  build-and-test:
    name: Build (PostgreSQL ${{ matrix.pg_version }})
    runs-on: ubuntu-latest
    needs: lint-and-format
    strategy:
      fail-fast: false
      matrix:
        pg_version: ['16', '17', '18']
        include:
          - pg_version: '16'
            pg_apt_version: '16'
          - pg_version: '17'
            pg_apt_version: '17'
          - pg_version: '18'
            pg_apt_version: '18'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: apt-${{ runner.os }}-pg${{ matrix.pg_version }}-${{ hashFiles('.github/workflows/extension-ci.yml') }}
          restore-keys: |
            apt-${{ runner.os }}-pg${{ matrix.pg_version }}-

      - name: Add PostgreSQL APT repository
        run: |
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update

      - name: Install PostgreSQL ${{ matrix.pg_version }}
        run: |
          sudo apt-get install -y --no-install-recommends \
            postgresql-${{ matrix.pg_apt_version }} \
            postgresql-server-dev-${{ matrix.pg_apt_version }}

      - name: Install build dependencies
        run: |
          sudo apt-get install -y --no-install-recommends \
            liblz4-dev \
            libzstd-dev \
            libcurl4-openssl-dev \
            libssl-dev \
            librdkafka-dev \
            build-essential

      - name: Cache extension build
        uses: actions/cache@v4
        with:
          path: |
            src/**/*.o
            extensions/postgres/**/*.o
            *.so
          key: ext-build-${{ runner.os }}-pg${{ matrix.pg_version }}-${{ hashFiles('src/**/*.c', 'src/**/*.h', 'Makefile') }}
          restore-keys: |
            ext-build-${{ runner.os }}-pg${{ matrix.pg_version }}-

      - name: Set PostgreSQL path
        run: |
          echo "PATH=/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH" >> $GITHUB_ENV
          echo "PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config" >> $GITHUB_ENV

      - name: Verify PostgreSQL version
        run: |
          pg_config --version
          which pg_config

      - name: Build extension
        run: |
          make clean || true
          make PG_CONFIG=$PG_CONFIG

      - name: Verify build artifacts
        run: |
          ls -la *.so 2>/dev/null || echo "No shared library in root"
          ls -la extensions/postgres/*.so 2>/dev/null || echo "No shared library in extensions/postgres"
          find . -name "*.so" -type f 2>/dev/null || echo "No .so files found"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: orochi-extension-pg${{ matrix.pg_version }}-${{ github.sha }}
          path: |
            *.so
            extensions/postgres/*.so
            sql/*.sql
          retention-days: 7
          if-no-files-found: warn

  # Standalone unit tests (no PostgreSQL required)
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            gcc

      - name: Cache unit test build
        uses: actions/cache@v4
        with:
          path: |
            test/unit/*.o
            test/unit/run_tests
          key: unit-tests-${{ runner.os }}-${{ hashFiles('test/unit/**/*.c', 'test/unit/**/*.h', 'test/unit/Makefile') }}
          restore-keys: |
            unit-tests-${{ runner.os }}-

      - name: Build unit tests
        working-directory: test/unit
        run: |
          make clean || true
          make

      - name: Run unit tests
        working-directory: test/unit
        run: ./run_tests

      - name: Run unit tests (verbose on failure)
        working-directory: test/unit
        run: ./run_tests --verbose
        if: failure()

  # Regression tests (requires PostgreSQL)
  regression-tests:
    name: Regression Tests (PostgreSQL ${{ matrix.pg_version }})
    runs-on: ubuntu-latest
    needs: [build-and-test, unit-tests]
    strategy:
      fail-fast: false
      matrix:
        pg_version: ['16', '17']
    services:
      postgres:
        image: postgres:${{ matrix.pg_version }}
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: orochi_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Add PostgreSQL APT repository
        run: |
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update

      - name: Install PostgreSQL client and dev headers
        run: |
          sudo apt-get install -y --no-install-recommends \
            postgresql-client-${{ matrix.pg_version }} \
            postgresql-server-dev-${{ matrix.pg_version }} \
            liblz4-dev \
            libzstd-dev \
            libcurl4-openssl-dev \
            libssl-dev \
            librdkafka-dev \
            build-essential

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: orochi-extension-pg${{ matrix.pg_version }}-${{ github.sha }}
          path: /tmp/orochi-artifacts
        continue-on-error: true

      - name: Build extension if artifacts missing
        run: |
          export PATH="/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH"
          make PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config
        if: ${{ hashFiles('/tmp/orochi-artifacts/*.so') == '' }}

      - name: Run regression tests
        run: |
          export PATH="/usr/lib/postgresql/${{ matrix.pg_version }}/bin:$PATH"
          make installcheck PGUSER=postgres PGPASSWORD=postgres PGHOST=localhost PGPORT=5432 || true
        env:
          PGPASSWORD: postgres

      - name: Upload regression test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: regression-results-pg${{ matrix.pg_version }}
          path: |
            test/regression.diffs
            test/results/
          retention-days: 7

  # Debug build for additional validation
  debug-build:
    name: Debug Build
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Add PostgreSQL APT repository
        run: |
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update

      - name: Install dependencies
        run: |
          sudo apt-get install -y --no-install-recommends \
            postgresql-16 \
            postgresql-server-dev-16 \
            liblz4-dev \
            libzstd-dev \
            libcurl4-openssl-dev \
            libssl-dev \
            librdkafka-dev \
            build-essential

      - name: Build with debug flags
        run: |
          make clean || true
          make DEBUG=1 PG_CONFIG=/usr/lib/postgresql/16/bin/pg_config

      - name: Verify debug symbols
        run: |
          file *.so 2>/dev/null | grep -i "not stripped" || echo "Debug build completed"

  # Summary status
  extension-ci-status:
    name: Extension CI Status
    runs-on: ubuntu-latest
    needs:
      - lint-and-format
      - build-and-test
      - unit-tests
      - regression-tests
      - debug-build
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          echo "=== Extension CI Status ==="
          echo "Lint:       ${{ needs.lint-and-format.result }}"
          echo "Build:      ${{ needs.build-and-test.result }}"
          echo "Unit:       ${{ needs.unit-tests.result }}"
          echo "Regression: ${{ needs.regression-tests.result }}"
          echo "Debug:      ${{ needs.debug-build.result }}"

          if [ "${{ needs.lint-and-format.result }}" != "success" ]; then
            echo "Lint failed"; exit 1
          fi
          if [ "${{ needs.build-and-test.result }}" != "success" ]; then
            echo "Build failed"; exit 1
          fi
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "Unit tests failed"; exit 1
          fi
          if [ "${{ needs.debug-build.result }}" != "success" ]; then
            echo "Debug build failed"; exit 1
          fi
          # Regression tests are allowed to fail for now
          if [ "${{ needs.regression-tests.result }}" == "failure" ]; then
            echo "WARNING: Regression tests failed (non-blocking)"
          fi

          echo "Extension CI passed!"
