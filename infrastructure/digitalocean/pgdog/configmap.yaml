apiVersion: v1
kind: ConfigMap
metadata:
  name: pgdog-config
  namespace: orochi-cloud
  labels:
    app: pgdog
    app.kubernetes.io/name: pgdog
    app.kubernetes.io/component: connection-pooler
    app.kubernetes.io/part-of: orochi-cloud
data:
  pgdog.toml: |
    # PgDog Configuration for Orochi Cloud Production
    # Validated against pgdog-config structs with deny_unknown_fields
    #
    # Auth chain: client -> jwt-proxy (JWT validation) -> PgDog (trust) -> DO managed DB (SCRAM)
    # Users and backend credentials are in users.toml (mounted from K8s secret)

    [general]
    host = "0.0.0.0"
    port = 6432
    workers = 0

    # Transaction-level pooling for maximum connection efficiency
    pooler_mode = "transaction"

    # Trust auth: only jwt-proxy on localhost connects to PgDog
    auth_type = "trust"

    # Pool sizing (conservative for DO managed DB connection limits)
    # DO basic plan has ~25 total connections; control-plane uses some
    default_pool_size = 5
    min_pool_size = 0

    # Load balancing
    load_balancing_strategy = "random"

    # Timeouts (milliseconds)
    connect_timeout = 5000
    query_timeout = 300000
    idle_timeout = 600000
    checkout_timeout = 5000
    shutdown_timeout = 10000
    server_lifetime = 3600000

    # Logging
    log_connections = true
    log_disconnections = true

    # Prometheus metrics
    openmetrics_port = 9090

    # TLS for client connections (jwt-proxy -> PgDog)
    tls_certificate = "/etc/pgdog/tls/tls.crt"
    tls_private_key = "/etc/pgdog/tls/tls.key"

    # Query parser for read/write splitting
    query_parser = "on"

    [admin]
    name = "pgdog"
    user = "pgdog_admin"
    password = "pgdog_admin"

    # =========================================================================
    # Backend Database: DigitalOcean Managed PostgreSQL
    # =========================================================================
    # Backend credentials (user/password) are set per-user in users.toml
    # via server_user/server_password fields (mounted from K8s secret).

    [[databases]]
    name = "orochi_cloud"
    host = "orochi-metadata-do-user-32140747-0.e.db.ondigitalocean.com"
    port = 25060
    database_name = "orochi_cloud"
    role = "primary"
