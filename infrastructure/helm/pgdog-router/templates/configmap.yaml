apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "pgdog-router.fullname" . }}
  labels:
    {{- include "pgdog-router.labels" . | nindent 4 }}
data:
  pgdog.toml: |
    # PgDog Configuration
    # Generated by Helm chart {{ .Chart.Name }}-{{ .Chart.Version }}

    [general]
    host = "{{ .Values.pgdog.general.host }}"
    port = {{ .Values.pgdog.general.port }}
    {{- if gt (int .Values.pgdog.general.workers) 0 }}
    workers = {{ .Values.pgdog.general.workers }}
    {{- end }}
    connect_timeout = {{ .Values.pgdog.general.connectTimeout }}
    {{- if gt (int .Values.pgdog.general.queryTimeout) 0 }}
    query_timeout = {{ .Values.pgdog.general.queryTimeout }}
    {{- end }}
    idle_timeout = {{ .Values.pgdog.general.idleTimeout }}
    shutdown_timeout = {{ .Values.pgdog.general.shutdownTimeout }}

    [admin]
    host = "0.0.0.0"
    port = {{ .Values.pgdog.general.adminPort }}

    [pools]
    default_pool_mode = "{{ .Values.pgdog.pool.mode }}"
    default_pool_size = {{ .Values.pgdog.pool.defaultSize }}
    min_pool_size = {{ .Values.pgdog.pool.minSize }}
    max_pool_size = {{ .Values.pgdog.pool.maxSize }}
    max_client_connections = {{ .Values.pgdog.pool.maxClientConnections }}
    {{- if gt (int .Values.pgdog.pool.connectionLifetime) 0 }}
    connection_lifetime = {{ .Values.pgdog.pool.connectionLifetime }}
    {{- end }}
    idle_connection_timeout = {{ .Values.pgdog.pool.idleConnectionTimeout }}
    queue_timeout = {{ .Values.pgdog.pool.queueTimeout }}
    queue_size = {{ .Values.pgdog.pool.queueSize }}

    {{- if .Values.pgdog.loadBalancing.enabled }}
    [load_balancing]
    enabled = true
    strategy = "{{ .Values.pgdog.loadBalancing.strategy }}"
    health_check_interval = {{ .Values.pgdog.loadBalancing.healthCheckInterval }}
    health_check_timeout = {{ .Values.pgdog.loadBalancing.healthCheckTimeout }}
    health_check_retries = {{ .Values.pgdog.loadBalancing.healthCheckRetries }}
    {{- end }}

    {{- if .Values.pgdog.routing.enabled }}
    [routing]
    enabled = true
    read_write_split = {{ .Values.pgdog.routing.readWriteSplit }}
    read_from_replica = {{ .Values.pgdog.routing.readFromReplica }}
    sticky_transactions = {{ .Values.pgdog.routing.stickyTransactions }}
    {{- end }}

    [auth]
    auth_type = "{{ .Values.pgdog.auth.type }}"
    {{- if .Values.pgdog.auth.defaultUser }}
    default_user = "{{ .Values.pgdog.auth.defaultUser }}"
    {{- end }}
    {{- if .Values.pgdog.auth.defaultDatabase }}
    default_database = "{{ .Values.pgdog.auth.defaultDatabase }}"
    {{- end }}

    [logging]
    level = "{{ .Values.pgdog.logging.level }}"
    format = "{{ .Values.pgdog.logging.format }}"
    log_queries = {{ .Values.pgdog.logging.logQueries }}
    {{- if gt (int .Values.pgdog.logging.slowQueryThreshold) 0 }}
    slow_query_threshold = {{ .Values.pgdog.logging.slowQueryThreshold }}
    {{- end }}

    {{- if .Values.pgdog.metrics.enabled }}
    [metrics]
    enabled = true
    path = "{{ .Values.pgdog.metrics.path }}"
    {{- end }}

    {{- if .Values.pgdog.tls.enabled }}
    [tls]
    enabled = true
    mode = "{{ .Values.pgdog.tls.mode }}"
    {{- if .Values.pgdog.tls.existingSecret }}
    certificate = "/etc/pgdog/tls/tls.crt"
    private_key = "/etc/pgdog/tls/tls.key"
    {{- if .Values.pgdog.tls.caCertificate }}
    ca_certificate = "/etc/pgdog/tls/ca.crt"
    {{- end }}
    {{- end }}
    {{- end }}

    # Upstream PostgreSQL Servers
    {{- if .Values.pgdog.upstreams }}
    [[pools]]
    name = "default"
    {{- range $index, $upstream := .Values.pgdog.upstreams }}

    [[pools.shards]]
    [[pools.shards.servers]]
    host = "{{ $upstream.host }}"
    port = {{ $upstream.port | default 5432 }}
    role = "{{ $upstream.role | default "primary" }}"
    {{- if $upstream.weight }}
    weight = {{ $upstream.weight }}
    {{- end }}
    {{- if $upstream.database }}
    database = "{{ $upstream.database }}"
    {{- end }}
    {{- end }}
    {{- end }}

    # Users
    {{- if .Values.pgdog.users }}
    {{- range .Values.pgdog.users }}

    [[users]]
    name = "{{ .name }}"
    {{- if .databases }}
    databases = [{{ range $i, $db := .databases }}{{ if $i }}, {{ end }}"{{ $db }}"{{ end }}]
    {{- end }}
    {{- if .poolSize }}
    pool_size = {{ .poolSize }}
    {{- end }}
    {{- if .poolMode }}
    pool_mode = "{{ .poolMode }}"
    {{- end }}
    {{- end }}
    {{- end }}

    # Custom Configuration
    {{- if .Values.pgdog.customConfig }}
    {{ toToml .Values.pgdog.customConfig | nindent 4 }}
    {{- end }}
