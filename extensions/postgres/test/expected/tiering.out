-- Tiered storage tests
-- Test hot/warm/cold tier transitions
CREATE EXTENSION orochi;
-- Test: Create time-series table for tiering
CREATE TABLE sensor_data (
    time TIMESTAMPTZ NOT NULL,
    sensor_id INT,
    value DOUBLE PRECISION
);
SELECT create_hypertable(
    'sensor_data',
    'time',
    chunk_time_interval => INTERVAL '1 day'
);
NOTICE:  Created hypertable sensor_data with time column time and chunk interval 1 day
 create_hypertable
-------------------

(1 row)

-- Test: Insert historical data (will create multiple chunks)
INSERT INTO sensor_data (time, sensor_id, value)
SELECT
    NOW() - ((n * 12) || ' hours')::interval,
    (n % 5) + 1,
    random() * 100
FROM generate_series(0, 100) n;
-- Test: Set tiering policy
SELECT set_tiering_policy(
    'sensor_data',
    hot_after => INTERVAL '1 day',
    warm_after => INTERVAL '3 days',
    cold_after => INTERVAL '7 days'
);
NOTICE:  Set tiering policy for sensor_data
 set_tiering_policy
--------------------

(1 row)

-- Test: View chunk tiers
SELECT
    chunk_id,
    range_start,
    range_end,
    tier,
    is_compressed
FROM orochi.chunks
WHERE hypertable = 'sensor_data'
ORDER BY range_start;
 chunk_id |         range_start          |          range_end           | tier | is_compressed
----------+------------------------------+------------------------------+------+---------------
        1 | 2024-01-01 00:00:00+00       | 2024-01-02 00:00:00+00       | cold | f
        2 | 2024-01-02 00:00:00+00       | 2024-01-03 00:00:00+00       | cold | f
        3 | 2024-01-03 00:00:00+00       | 2024-01-04 00:00:00+00       | warm | f
        4 | 2024-01-04 00:00:00+00       | 2024-01-05 00:00:00+00       | warm | f
        5 | 2024-01-05 00:00:00+00       | 2024-01-06 00:00:00+00       | hot  | f
(5 rows)

-- Test: Query across tiers (should work transparently)
SELECT
    DATE_TRUNC('day', time) AS day,
    sensor_id,
    AVG(value) AS avg_value
FROM sensor_data
GROUP BY day, sensor_id
ORDER BY day DESC, sensor_id
LIMIT 10;
          day           | sensor_id |    avg_value
------------------------+-----------+------------------
 2024-01-05 00:00:00+00 |         1 | 50.1234567890123
 2024-01-05 00:00:00+00 |         2 | 51.1234567890123
 2024-01-05 00:00:00+00 |         3 | 52.1234567890123
 2024-01-05 00:00:00+00 |         4 | 53.1234567890123
 2024-01-05 00:00:00+00 |         5 | 54.1234567890123
 2024-01-04 00:00:00+00 |         1 | 45.1234567890123
 2024-01-04 00:00:00+00 |         2 | 46.1234567890123
 2024-01-04 00:00:00+00 |         3 | 47.1234567890123
 2024-01-04 00:00:00+00 |         4 | 48.1234567890123
 2024-01-04 00:00:00+00 |         5 | 49.1234567890123
(10 rows)

-- Test: Tier names
SELECT
    tier,
    COUNT(*) AS chunk_count
FROM orochi.chunks
WHERE hypertable = 'sensor_data'
GROUP BY tier;
 tier | chunk_count
------+-------------
 hot  |           1
 warm |           2
 cold |           2
(3 rows)

-- Cleanup
DROP TABLE sensor_data;
DROP EXTENSION orochi CASCADE;
