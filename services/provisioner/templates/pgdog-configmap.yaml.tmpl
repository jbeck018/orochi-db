# PgDog ConfigMap Template
# This template generates the PgDog configuration (pgdog.toml) as a Kubernetes ConfigMap.
#
# Variables:
#   .Name              - Cluster name
#   .Namespace         - Kubernetes namespace
#   .Pooler            - ConnectionPoolerSpec configuration
#     .Mode            - Pool mode (transaction, session)
#     .MaxPoolSize     - Maximum pool size
#     .MinPoolSize     - Minimum pool size
#     .IdleTimeout     - Idle timeout in seconds
#     .ReadWriteSplit  - Whether to enable read/write splitting
#     .ShardingEnabled - Whether sharding is enabled
#     .ShardCount      - Number of shards
#     .TLSEnabled      - Whether TLS is enabled
#   .Labels            - Additional labels

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Name }}-pgdog-config
  namespace: {{ .Namespace }}
  labels:
    app: pgdog
    app.kubernetes.io/name: pgdog
    app.kubernetes.io/instance: {{ .Name }}
    app.kubernetes.io/component: connection-pooler
    app.kubernetes.io/part-of: orochi-db
    app.kubernetes.io/managed-by: orochi-provisioner
    orochi.io/cluster-name: {{ .Name }}
{{- if .Labels }}
{{ toYaml .Labels | indent 4 }}
{{- end }}
data:
  pgdog.toml: |
    # PgDog Configuration for {{ .Name }}
    # Auto-generated by Orochi Provisioner
    # Documentation: https://pgdog.dev/docs/configuration

    # ==============================================================================
    # General Settings
    # ==============================================================================
    [general]
    host = "0.0.0.0"
    port = 6432
    admin_port = 6433

    # Connection timeouts (milliseconds)
    connect_timeout = 5000
    query_timeout = 300000
    idle_timeout = {{ default 600 .Pooler.IdleTimeout }}000
    checkout_timeout = 5000
    shutdown_timeout = 10000

    # Worker configuration (0 = auto-detect based on CPU cores)
    workers = 0

    # TCP keepalive settings
    tcp_keepalive = true
    tcp_keepalive_idle = 60
    tcp_keepalive_interval = 15
    tcp_keepalive_count = 3

    # TLS configuration
    tls = {{ boolToString .Pooler.TLSEnabled }}
{{- if .Pooler.TLSEnabled }}
    tls_certificate = "/etc/pgdog/tls/tls.crt"
    tls_private_key = "/etc/pgdog/tls/tls.key"
{{- end }}

    # Prometheus metrics
    prometheus_enabled = true
    prometheus_port = 9090

    # Logging
    log_level = "info"
    log_client_connections = true
    log_client_disconnections = true

    # ==============================================================================
    # Authentication
    # ==============================================================================
    [auth]
    auth_type = "scram-sha-256"

    # ==============================================================================
    # Pool Configuration
    # ==============================================================================
    [pools]
    default_pool_size = 25
    min_pool_size = {{ default 5 .Pooler.MinPoolSize }}
    max_pool_size = {{ default 100 .Pooler.MaxPoolSize }}

    # Pool mode: session, transaction, statement
    pool_mode = "{{ default "transaction" .Pooler.Mode }}"

    # Reserve connections for superusers
    reserve_pool_size = 5
    reserve_pool_timeout = 3000

    # Server connection lifetime (milliseconds)
    server_lifetime = 3600000
    server_idle_timeout = {{ default 600 .Pooler.IdleTimeout }}000

    # Prepared statement handling
    prepared_statements = true

    # Load balancing strategy: round_robin, random, least_connections
    load_balancing = "least_connections"

{{- if .Pooler.ShardingEnabled }}
    # ==============================================================================
    # Sharding Configuration
    # ==============================================================================
    [sharding]
    enabled = true
    method = "hash"
    shard_count = {{ default 32 .Pooler.ShardCount }}
    automatic_sharding = true
    default_shard = "any"
{{- end }}

    # ==============================================================================
    # Query Routing Plugin
    # ==============================================================================
    [plugins.query_router]
    enabled = true
    read_write_splitting = {{ boolToString .Pooler.ReadWriteSplit }}

    # ==============================================================================
    # Health Check Configuration
    # ==============================================================================
    [health_check]
    query = "SELECT 1"
    interval = 10000
    timeout = 5000
    retries = 3
    retry_delay = 1000
    ban_duration = 60000

    # ==============================================================================
    # Database Clusters Configuration
    # ==============================================================================

    # Primary cluster (read-write)
    [[clusters]]
    name = "primary"

      [[clusters.databases]]
      name = "{{ .Name }}"
      host = "{{ .Name }}-rw.{{ .Namespace }}.svc.cluster.local"
      port = 5432
      database = "postgres"
      role = "primary"

{{- if .Pooler.ReadWriteSplit }}
      # Replica for read-only queries
      [[clusters.databases]]
      name = "{{ .Name }}_replica"
      host = "{{ .Name }}-ro.{{ .Namespace }}.svc.cluster.local"
      port = 5432
      database = "postgres"
      role = "replica"
{{- end }}

    # ==============================================================================
    # User Configuration
    # ==============================================================================

    [[users]]
    name = "orochi_app"
    pool_size = 50
    pool_mode = "{{ default "transaction" .Pooler.Mode }}"

    [[users]]
    name = "orochi_admin"
    pool_size = 10
    pool_mode = "session"

    [[users]]
    name = "orochi_readonly"
    pool_size = 100
    pool_mode = "{{ default "transaction" .Pooler.Mode }}"
    default_role = "replica"
